# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

name: _docker

on:
  workflow_call:
permissions:
  contents: read
defaults:
 run:
  working-directory: .
env:
  REGISTRY: faezsal
  IMAGE_NAME: symfony-shop-app
jobs:
  InitTest:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout
          uses: actions/checkout@v4

  push-docker-image:
    name: push docker image to hub
    runs-on: ubuntu-latest
    steps:
      - name: check repository
        uses: actions/checkout@v4
      - name: display the fodler
        run: |
          pwd
          ls
      - name: login to docker registry
        uses: docker/login-action@v3
        with:
          username: ${{secrets.DOCKERHUB_USERNAME}}
          password: ${{secrets.DOCKERHUB_TOKEN}}
      - name: remove cache
        run: rm -rf var/cache/dev 
      - name: permission cache
        run: sudo chown -R www-data:www-data var/cache/dev 
      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@98669ae865ea3cffbcbaa878cf57c20bbf1c6c38
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}

      - name: build and push docker image to registry
        uses: docker/build-push-action@v5
        with:
          context: ./container/symfony/
          dockerfile: ./container/symfony/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}